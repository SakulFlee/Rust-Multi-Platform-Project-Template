# Use the osxcross base image with Ubuntu as the base
ARG OSXCROSS_VERSION=latest
FROM --platform=$BUILDPLATFORM ghcr.io/crazy-max/osxcross:${OSXCROSS_VERSION}-ubuntu

# Install additional required packages
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    ca-certificates \
    build-essential \
    git \
    jq \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
ARG RUST_VERSION=1.92
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${RUST_VERSION} --profile minimal
ENV PATH="/root/.cargo/bin:${PATH}"

# Set up the working directory
WORKDIR /workspace

# Copy the project files
COPY . .

# Install XCodeGen (for iOS builds)
RUN curl -L https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen_linux.tar.gz -o xcodegen.tar.gz && \
    tar -xzf xcodegen.tar.gz && \
    mv xcodegen /usr/local/bin/ && \
    rm xcodegen.tar.gz

# Install additional tools for iOS
RUN rustup component add rust-src

# Set environment variables
ENV CARGO_TERM_COLOR=always
ENV RUST_BACKTRACE=1

# Default command
CMD ["bash"]
